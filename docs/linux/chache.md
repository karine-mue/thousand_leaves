# キャッシュについて

## 1. キャッシュとは
ディスク上にあるデータを処理する場合、一度読み込んでから処理をします
その一時置き場です

## 2. Linuxのキャッシュの種類と捨て方
| 値   | 捨てる対象                 | 内容                                    |
| --- | --------------------- | ------------------------------------- |
| `1` | **PageCache**         | ファイルデータのキャッシュ（read() された内容など）         |
| `2` | **dentries / inodes** | ディレクトリエントリ・inode構造体のキャッシュ             |
| `3` | **両方（1 + 2）**         | PageCache + dentries + inodes の全キャッシュ |


### 2-1. 【1】PageCache
- **PageCacheとは？**
Linuxではファイルを読み書きするたびに、一度読み込んだデータをメモリ上に保持します
これが PageCacheです
たとえば `cat bigfile.csv` の後にもう一度同じファイルを読むとディスクではなくメモリから読むため非常に速いです
cat, grep, wc などで読むとここに溜まります

- **PageCache に含まれるのは？**
  - ファイルのバイナリ/テキストの実データ
  - read() された結果

- **ダーティキャッシュ（Dirty Pages）とは？**
書き換えられたけどまだディスクに反映されていないページのことです
たとえば echo test >> file.txt 直後はディスクに未反映ですが、PageCacheには反映済です
drop_cacheはクリーンなキャッシュしか捨てられない（未書き込みは捨てられない）ため、先に`sync`（書き込み）が必要です
```
sudo sync  # Dirtyページをフラッシュ（書き込み）
echo 1 | sudo tee /proc/sys/vm/drop_caches

```

### 2-2. 【2】**dentries / inodes**
- **inodesとは？**
  - ファイルの メタデータを格納する構造体
  - 含まれるもの：
  - ファイルサイズ
  - 所有者・パーミッション
  - タイムスタンプ（作成・変更・アクセス）
  - ディスクブロックの位置情報（＝どこに保存されているか）

- **dentriesとは？**
  - ファイル名とinodeの対応付けのこと
  - パス /var/log/syslog を解決するための辞書のようなもの

- **構造体がキャッシュされる理由**
find や ls -R などで大量にディレクトリを走査するとinodeやdentryが大量にメモリにキャッシュされます
そのため何がどこにあったかを持っておく仕組みになっています
再度のアクセスは速くなるもののメモリ圧迫の原因にもなります

## 3. 実務での選び方

| 状況                           | 推奨値 | 解説                        |
| ---------------------------- | --- | ------------------------- |
| ファイル読み込み速度を初期状態で再計測したい       | `1` | I/Oキャッシュの影響を除くため          |
| 大量の `find` / `ls` でメモリが食われてる | `2` | inode/dentryがメモリ圧迫しているケース |
| **完全初期化**して負荷テストしたい          | `3` | 実運用では慎重に（全体に影響）           |

- drop_caches は読み取り専用の再利用メモリを開放するだけで、システムに悪影響は基本的にありません（sync 実行が前提）。
- パフォーマンスは一時的に悪化します。
- OS全体に影響するため、本番環境では通常使用しません。
- Docker や仮想環境ではホストOSの権限が必要で実行できないことが多いです。