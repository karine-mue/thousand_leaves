# 見つけた対象に対して処理をする(find -exec)
特定のディレクトリ配下のファイルに対して一律に処理をかけたいことがあります
そういう時に便利なのがこの`find -exec`です

## 1. 基本形
`find [検索パス] [条件] -exec [コマンド] {} \;`

- 検索パス: カレントディレクトリ（今いる場所）なら . 
- 条件: 形式や名前など
    - ファイルに限定する: `-type f`
    - 名前: `-name "prefix*"` など。正規表現が使えます。
- コマンド: `wc -l`(行数カウント)、 `cp`（コピー）など
- `{}`: findで見つけたファイルがここに入る
- `\;` : -execの終端符号（詳しくは「3. `\;`と`+`の違い」にて）

## 2. コマンド例

- **配下にある特定文字列で始まるファイルの行数を取得し、csvファイルとして出力する**
`find . -type f -name "prefix_*" -exec sh -c 'for f; do echo "$(wc -l < "$f"),$f"; done' _ {} + > line_counts.csv`

- **標準出力でok(csv不要)ならこれでも(行数カウント)**
`find . -type f -name "prefix_*" -exec sh -c 'for f; do wc -l "$f"; done' _ {} +`

- **配下の特定名称のファイルに対して置換処理を実行する**
`find . -type f -name "filename.txt" -exec sed -i.bak 's/old_string/new_string/g' {} \;`

- **拡張子を指定して(.txt)現在のディレクトリ配下のファイルを特定のディレクトリ(backup)へ移動する**
`find . -name "*.txt" -exec cp {} /backup/ \;`

- **拡張子を変換して移動する（例：.md → .txt）**
`find . -name "*.md" -exec sh -c 'mv "$1" "${1%.md}.txt"' _ {} \;`

- **確認付き削除**
`find . -name "*.bak" -ok rm {} \;`

- **確認無し削除**
`find . -name "*.tmp" -exec rm {} \;`

- **ファイル名を表示する**
`find . -type f -exec echo "Found file:" {} \;`

## 3. `\;`と`+`の違い
`\;`は逐次実行、`+`はまとめて実行する、という違いがあります
| 特徴   | `-exec ... \;` | `-exec ... +`                |
| ---- | -------------- | ---------------------------- |
| 実行方法 | **1ファイルずつ**実行  | **複数ファイルまとめて**実行             |
| 処理回数 | ファイル数だけコマンドを実行 | ファイルを**可能なだけまとめて**1回で実行      |
| 効率   | 遅い（非効率）        | 速い（効率的）                      |
| 対応状況 | ほぼすべての環境で使える   | **GNU find限定**（Macや古い環境では注意） |

### 3-1. **注意点**
主な注意点と推奨構文は以下のとおり

| 処理内容            | 推奨構文                                   |
| --------------- | -------------------------------------- |
| 削除（`rm`）        | `-exec rm {} +`                       |
| 行数確認（`wc -l`）   | `-exec wc -l {} +`                    |
| コピー（`cp`, `mv`） | 基本は `\;`（要個別）                          |
| 個別ログ出力など        | `\;` で個別に処理                            |
| 任意スクリプトでループ     | `sh -c 'for f; do ...; done' _ {} +`  |

- **コマンドによってはまとめて実行することができない:**
mv や cp は2つの引数しか取れないので + は使いにくいです
- **順序の保障がありません:**
`+` ではファイル順序は保証されません、そのため意図した結果と違うものになることがあります
- **環境によって未対応:**
古い find（特にBSD系など）では `+`は 非対応です
`-execdir` と組み合わせるとさらに非対応が増えます
- **メモリ圧迫・I/O過多:**
`+` はOSの `ARG_MAX` に達するまでファイルを詰め込みます
多数の大ファイルを `cat` したりすると、I/Oが詰まって処理が落ちることがあります
特にSSD/HDDのキャッシュが枯渇してI/O waitが増加しやすいです
vmstatなどで稼働状況をモニタリングし、詰まっているようなら小分けにするとよいです
  - **小分け例**
`find . -type f -name "prefix_*" -exec sh -c 'for f; do wc -l "$f"; sleep 0.01; done' _ {} +`
- **キャッシュで騙される:**
例えば「テスト環境で早く終わるのに、本番では異様に遅い」ようなケースがあります
キャッシュにあるか無いかで処理時間は雲泥の差なので、処理時間予測をする際の処理速度ベースは予めキャッシュをクリアした状態取っておいたほうが外れがないです
※テスト環境推奨。**本番環境での実行は慎重に、他の処理に影響をあたえることがあります**
キャッシュの捨て方: 
```
sudo sync
sudo sh -c "echo 3 > /proc/sys/vm/drop_caches"
```
※キャッシュについての詳細は [キャッシュについて](./chache.md)もあわせて参照してください

## 4. `+`と`xargs`の違い

| 項目         | `find -exec ... +`      | `xargs`                         |
| ---------- | ----------------------- | ------------------------------- |
| 引数の渡し方     | `find` がファイル名を直接コマンドに渡す | 標準入力から読み取り、コマンドに渡す              |
| 空白・改行・特殊文字 | 自動で安全に処理（POSIX的に安全）     | デフォルトでは**空白・改行で壊れる**（`-0`が必要）   |
| NULL区切り対応  | 不要（`{}`展開は安全）           | **`-0`と`-print0`で対応必須**         |
| 並列処理       | 不可                      | `-P` オプションで並列可能（例：`xargs -P 4`） |
| コマンドテンプレート | 固定：`{}`のみ（複雑な構造には弱い）    | `-I {}` で柔軟に構造化可能               |
| エラー処理      | ファイル1つずつ失敗しても他へ影響しにくい   | 中央で止まることもある（並列時要注意）             |
| 実行対象の柔軟性   | `find` の内部制御なので密結合      | `find` 以外の出力でも使える（汎用性高い）        |
| パフォーマンス    | 非常に高速（`rm {}` +で1回呼び出し） | 同等以上だが細かく制御できる分やや複雑             |

- **具体例: .logファイルをまとめて削除**
  - `find . -name "*.log" -exec rm {} +` → 安全かつ高速
  - `find . -name "*.log" | xargs rm` → 速いが状況次第で危険（ファイル名に空白が入っていると失敗する）
  - `find . -name "*.log" -print0 | xargs -0 rm` → 上記対応として `-0` オプションを入れる

- **考慮すべきこと**
`find -exec +`はGNU拡張なのでPOSIX準拠ではなく、macOSや一部UNIXでは使えないことがある。
`+`を使うと`find`コマンドが失敗するケースがある

- **使い分けまとめ**

| ケース                    | 推奨                   |
| ---------------------- | -------------------- |
| **高速かつ安全にまとめて処理**      |  `find -exec {} +`  |
| **並列処理したい**            |  `xargs -P`         |
| **複雑なコマンドテンプレートを使いたい** |  `xargs -I {}`      |
| **POSIX環境の互換性を重視**     |  `xargs`（より広範に対応）   |
| **1ファイルずつ安全に処理したい**    |  `find -exec {} \;` |
